---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostsList from '../components/PostsList.astro';
import TagsList from '../components/TagsList.astro';
import { getTagsWithCounts } from '../lib/tagHelpers';
import { sortPostsByDate } from '../lib/content-utils';
import { config } from '../../blog.config';

const allPosts = await getCollection('posts', ({ data }) => {
  // Filter out drafts in production
  if (import.meta.env.PROD) {
    return !data.draft;
  }
  return true;
});

const posts = sortPostsByDate(allPosts);
const tagsWithCounts = getTagsWithCounts(allPosts);
const tags = tagsWithCounts.map(({ tag }) => tag);
const counts = Object.fromEntries(tagsWithCounts.map(({ tag, count }) => [tag, count]));
---

<BaseLayout title={config.title} description={config.description}>
  {tagsWithCounts.length > 0 && (
    <TagsList tags={tags} showCounts={true} counts={counts} class="mt-8 md:mt-4" />
  )}
  <PostsList posts={posts} />
</BaseLayout>
